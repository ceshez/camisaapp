<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrusel de Camisetas</title>
    <style>
        .carousel {
          display: flex;
          flex-direction: row;
          overflow-x: auto;
          scroll-snap-type: x mandatory;
          scroll-behavior: smooth;
          -webkit-overflow-scrolling: touch;
        }
        .carousel::-webkit-scrollbar {
          display: none;
        }
        .carousel {
          scrollbar-width: none;
          -ms-overflow-style: none;
        }
        .card {
          flex-shrink: 0;
          flex-basis: 200px;
          scroll-snap-align: start;
          margin-right: 1rem;
          border: 1px solid #ccc;
          border-radius: 5px;
          padding: 1rem;
          background: #fafafa;
        }
        .card:last-child {
          margin-right: 0;
        }
        .shirt-preview {
          margin-bottom: 0.5rem;
        }
        .nombre-creador {
          font-size: 1.1rem;
          margin: 0.5rem 0 0.25rem;
        }
        .calificacion, .fecha {
          font-size: 0.9rem;
          margin: 0.25rem 0;
        }
        button.btn-like, button.btn-dislike {
          margin: 0.5rem 0.5rem 0 0;
          padding: 0.4rem 0.8rem;
          border: none;
          border-radius: 3px;
          cursor: pointer;
        }
        button.btn-like { background-color: #4caf50; color: #fff; }
        button.btn-dislike { background-color: #f44336; color: #fff; }
        button.btn-like:hover { background-color: #45a049; }
        button.btn-dislike:hover { background-color: #e53935; }
    </style>
</head>
<body>
    <div class="carousel" id="contenedor-camisetas">
    <!-- Las tarjetas se insertarán aquí dinámicamente con JS -->
    </div>

<script>
function formatearFecha(isoDate) {
  const opciones = { year: 'numeric', month: 'numeric', day: 'numeric' };
  return new Date(isoDate).toLocaleDateString('es-ES', opciones);
}
function generarMiniatura(c) {
  return `
  <svg class="miniatura" viewBox="1 2 26 14">
    <path d="M 4 8 M 5 3 L 5 6 L 3 7 L 1 5" fill="${c.mangaIzqColor}" />
    <path d="M 9 5 L 7 3 L 5 3 L 5 6 L 5 12 L 13 12 L 13 6 L 13 3 L 11 3" fill="${c.torsoColor}" />
    <path d="M 13 6 L 13 3 L 17 5 L 15 7" fill="${c.mangaDerColor}" />
    <path d="M 8 2 L 7 3 L 9 5 L 8 3" fill="${c.cuelloIzqColor}" />
    <path d="M 10 2 L 11 3 L 9 5 L 10 3 M 1 4" fill="${c.cuelloDerColor}" />
  </svg>`;
}

async function cargarCamisetas() {
  try {
    const resp = await fetch('/api/camisetas', {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    });
    const camisetas = await resp.json();

    const contenedor = document.getElementById('contenedor-camisetas');
    contenedor.innerHTML = ''; // Limpiar carrusel

    camisetas.forEach(c => {
      let nombre = 'Desconocido';
      if (c.creador && typeof c.creador === 'object') {
        nombre = c.creador.nombre || c.creador.correo || 'Usuario';
      } else if (typeof c.creador === 'string') {
        nombre = c.creador;
      }

      const calificacion = typeof c.calificacion === 'number' ? c.calificacion.toFixed(1) : '0.0';

      const card = document.createElement('div');
      card.classList.add('card');
      card.innerHTML = `
        <div class="shirt-preview">${generarMiniatura(c)}</div>
        <div class="nombre-creador">${nombre}</div>
        <div class="calificacion">Calificación: ⭐ ${calificacion}</div>
        <div class="fecha">${formatearFecha(c.fechaCreacion)}</div>
        <div class="botones-reaccion">
          <button class="btn-like" onclick="reaccion('${c._id}', 1)">Me gusta</button>
          <button class="btn-dislike" onclick="reaccion('${c._id}', -1)">No me gusta</button>
        </div>
      `;
      contenedor.appendChild(card);
    });

  } catch (error) {
    console.error('Error al cargar camisetas:', error);
  }
}

// Enviar voto a la API y actualizar carrusel
async function reaccion(id, valor) {
try {
const resp = await fetch(`/api/camisetas/vota/${id}`, {
method: 'PUT',
headers: {
'Content-Type': 'application/json',
'Authorization': 'Bearer ' + localStorage.getItem('token')
},
body: JSON.stringify({ calificacion: valor }) // 1 o -1
});

if (resp.ok) {
const result = await resp.json();
console.log('Actualización exitosa:', result);
await cargarCamisetas(); // Refrescar lista después del voto
} else {
const error = await resp.json();
alert('Error al votar: ' + error.error);
}
} catch (error) {
alert('Error al conectar con el servidor');
}
}
window.reaccion = reaccion;
// Cargar las camisetas al iniciar la página
cargarCamisetas();
</script>
</body>
</html>